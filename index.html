<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Emerald City Hub</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Team Accents */
        .mariners { border-left-color: #005C5C; --accent: #005C5C; } 
        .seahawks { border-left-color: #69BE28; --accent: #69BE28; }
        .kraken { border-left-color: #99D9D9; --accent: #99D9D9; }
        .sounders { border-left-color: #5D9741; --accent: #5D9741; }
        .huskies { border-left-color: #4B2E83; --accent: #4B2E83; }
        .mancity { border-left-color: #6CABDD; --accent: #6CABDD; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-item.active { color: #2dd4bf; }
        .nav-item.active i { transform: translateY(-2px); }
        
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .live-dot { height: 6px; width: 6px; background-color: #ef4444; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- API KEY ---
        const YT_API_KEY = 'AIzaSyAo9TyNLEK7cR9GGGwirMlwAqmQ0bVT360'; 

        const LEAGUE_KEYWORDS = ["roundup", "wrap", "scores", "standings", "playoff", "power rankings", "week", "predictions"];

        // CONFIG: Using Hybrid Method (Playlist vs Search) to fix 404s
        const TEAMS = [
            { 
                id: "mariners", name: "Mariners", class: "mariners", sport: "baseball", league: "mlb", teamId: "11",
                keywords: ["mariners", "seattle"],
                method: "playlist", value: "UUWWLs-O8JGYYcNea7AgumAA" 
            },
            { 
                id: "seahawks", name: "Seahawks", class: "seahawks", sport: "football", league: "nfl", teamId: "26",
                keywords: ["seahawks", "seattle"],
                method: "playlist", value: "UUzkFCRiMcOBeef8xcaqipmw" 
            },
            { 
                id: "kraken", name: "Kraken", class: "kraken", sport: "hockey", league: "nhl", teamId: "55",
                keywords: ["kraken"],
                method: "search", value: "Seattle Kraken" // Playlist 404s -> Use Search
            },
            { 
                id: "sounders", name: "Sounders", class: "sounders", sport: "soccer", league: "usa.1", teamId: "2526",
                keywords: ["sounders"],
                method: "search", value: "Seattle Sounders FC" // Playlist 404s -> Use Search
            },
            { 
                id: "huskies", name: "Huskies", class: "huskies", sport: "football", league: "college-football", teamId: "264",
                keywords: ["huskies", "washington", "uw"],
                method: "playlist", value: "UUyTiy1J0SA5gnOLC0or_OIQ" 
            },
            { 
                id: "mancity", name: "Man City", class: "mancity", sport: "soccer", league: "eng.1", teamId: "382",
                keywords: ["man city", "manchester city", "city", "guardiola", "haaland"],
                method: "playlist", value: "UUkzCjdRMrW2vXLx8mvPVLdQ" 
            }
        ];

        const formatTime = (dateString, includeDate = true) => {
            if (!dateString) return "";
            const date = new Date(dateString);
            const today = new Date();
            const isToday = date.toDateString() === today.toDateString();
            const timeOpt = { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'Europe/Amsterdam' };
            const time = date.toLocaleTimeString('en-US', timeOpt);
            if (!includeDate) return time;
            if (isToday) return `Today, ${time}`;
            const dateOpt = { day: 'numeric', month: 'short', timeZone: 'Europe/Amsterdam' };
            return `${date.toLocaleDateString('en-US', dateOpt)} ${time}`;
        };

        function App() {
            const [filter, setFilter] = useState('all'); 
            const [data, setData] = useState({ scores: {}, news: [], videos: [], loading: true });

            useEffect(() => { loadAll(); }, []);

            const loadAll = async () => {
                setData(prev => ({ ...prev, loading: true }));
                
                const scores = {};
                let collectedNews = [];
                let collectedVideos = [];

                // 1. FETCH GOOGLE NEWS (Restored)
                try {
                    const teamQuery = "Seattle Mariners OR Seahawks OR Kraken OR Sounders OR \"Manchester City\" OR \"Man City\" OR \"Washington Huskies\"";
                    const googleUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(teamQuery)}&hl=en-US&gl=US&ceid=US:en`;
                    const r = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(googleUrl)}`);
                    const j = await r.json();
                    if (j.status === 'ok' && j.items) {
                        const googleItems = j.items.slice(0, 8).map(i => ({
                            title: i.title,
                            link: i.link,
                            pubDate: i.pubDate,
                            author: i.author || "Local News",
                            source: "LOCAL",
                            type: 'news',
                            teamClass: 'border-gray-500'
                        }));
                        collectedNews.push(...googleItems);
                    }
                } catch(e) { console.log("Google RSS Error", e); }

                // 2. FETCH ESPN DATA
                await Promise.all(TEAMS.map(async t => {
                    // SCORES
                    try {
                        const r = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${t.sport}/${t.league}/teams/${t.teamId}`);
                        const j = await r.json();
                        const nextEvent = j.team.nextEvent ? j.team.nextEvent[0] : null;

                        if (nextEvent) {
                            const competition = nextEvent.competitions[0];
                            const status = competition.status.type.shortDetail; 
                            const isLive = competition.status.type.state === "in";
                            const isFinal = competition.status.type.state === "post";
                            
                            const myTeamData = competition.competitors.find(c => c.team.id === j.team.id);
                            const oppTeamData = competition.competitors.find(c => c.team.id !== j.team.id);
                            
                            scores[t.id] = {
                                active: true,
                                status: status,
                                isLive: isLive,
                                isFinal: isFinal,
                                opponent: oppTeamData.team.abbreviation || oppTeamData.team.shortDisplayName,
                                myScore: myTeamData.score?.displayValue,
                                oppScore: oppTeamData.score?.displayValue,
                                date: competition.date 
                            };
                        } else {
                            scores[t.id] = { active: false, status: "Standby" };
                        }
                    } catch(e) {
                        scores[t.id] = { active: false, status: "..." };
                    }

                    // ESPN NEWS
                    try {
                        const newsR = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${t.sport}/${t.league}/news?limit=5&team=${t.teamId}`);
                        const newsJ = await newsR.json();
                        
                        if (newsJ.articles) {
                            const filteredArticles = newsJ.articles.filter(article => {
                                const titleLower = article.headline.toLowerCase();
                                const matchesTeam = t.keywords.some(k => titleLower.includes(k));
                                const matchesLeague = LEAGUE_KEYWORDS.some(k => titleLower.includes(k));
                                return matchesTeam || matchesLeague;
                            });

                            const teamNews = filteredArticles.slice(0, 3).map(article => ({
                                title: article.headline,
                                link: article.links?.web?.href,
                                pubDate: article.published,
                                author: t.name,
                                source: "ESPN",
                                thumbnail: article.images && article.images.length > 0 ? article.images[0].url : null,
                                type: 'news',
                                teamClass: t.class
                            }));
                            collectedNews.push(...teamNews);
                        }
                    } catch(e) {}
                }));

                // 3. FETCH VIDEOS (Hybrid Method: Playlist or Search)
                if (YT_API_KEY) {
                    await Promise.all(TEAMS.map(async t => { 
                        try {
                            let url = "";
                            // Switch method based on team config
                            if (t.method === "playlist") {
                                url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${t.value}&maxResults=10&key=${YT_API_KEY}`;
                            } else {
                                url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(t.value + " official")}&type=video&order=date&maxResults=5&key=${YT_API_KEY}`;
                            }

                            const r = await fetch(url);
                            const j = await r.json();
                            
                            if (j.items && j.items.length > 0) {
                                // Smart Filter: Avoid shorts
                                let bestVideo = j.items.find(v => {
                                    const title = v.snippet.title.toLowerCase();
                                    return !title.includes("#shorts") && !title.includes("shorts");
                                });

                                if (!bestVideo) bestVideo = j.items[0];

                                // ID logic differs between Search and Playlist API
                                const videoId = t.method === "playlist" ? bestVideo.snippet.resourceId.videoId : bestVideo.id.videoId;

                                collectedVideos.push({ 
                                    title: bestVideo.snippet.title, 
                                    id: videoId, 
                                    pubDate: bestVideo.snippet.publishedAt,
                                    team: t.name,
                                    source: "VIDEO",
                                    thumbnail: bestVideo.snippet.thumbnails.medium.url,
                                    type: 'video',
                                    teamClass: t.class
                                });
                            }
                        } catch(e) { console.error("YT Error", t.name); }
                    }));
                }

                setData({ scores, news: collectedNews, videos: collectedVideos, loading: false });
            };

            // ORIGINAL FILTERING LOGIC
            const feed = useMemo(() => {
                let combined = [];
                if (filter === 'all' || filter === 'news') combined.push(...data.news);
                if (filter === 'all' || filter === 'videos') combined.push(...data.videos);
                
                const unique = combined.filter((v,i,a)=>a.findIndex(t=>(t.title === v.title))===i);
                
                return unique.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            }, [data, filter]);

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-[#0f172a] relative">
                    
                    {/* Header */}
                    <div className="px-4 py-3 flex justify-between items-center bg-[#0f172a] z-20">
                        <h1 className="text-xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-emerald-500">
                            EMERALD HUB
                        </h1>
                        <button onClick={loadAll} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center active:scale-90 transition">
                            <i className={`fas fa-sync-alt text-xs ${data.loading ? 'fa-spin text-teal-400' : 'text-gray-400'}`}></i>
                        </button>
                    </div>

                    {/* SCOREBOARD */}
                    <div className="pl-4 pb-2 border-b border-white/5">
                        <div className="flex gap-3 overflow-x-auto no-scrollbar pr-4">
                            {TEAMS.map(t => {
                                const s = data.scores[t.id];
                                return (
                                    <div key={t.id} className={`flex-shrink-0 w-32 bg-white/5 rounded p-2 border-l-4 ${t.class} flex flex-col justify-between h-16`}>
                                        <div className="flex justify-between items-center">
                                            <span className="text-[10px] font-bold uppercase tracking-wide opacity-70">{t.name}</span>
                                            {s && s.isLive && <span className="text-[8px] text-red-400 font-bold flex items-center gap-1"><span className="live-dot"></span> LIVE</span>}
                                            {s && s.isFinal && <span className="text-[8px] bg-white/10 px-1 rounded text-gray-400">FINAL</span>}
                                        </div>
                                        
                                        <div className="mt-1">
                                            {s && s.active ? (
                                                (s.isLive || s.isFinal) ? (
                                                    <div className="flex items-end gap-2">
                                                        <span className="text-lg font-bold leading-none">{s.myScore}</span>
                                                        <span className="text-xs opacity-50 mb-0.5">-</span>
                                                        <span className="text-lg font-bold opacity-60 leading-none">{s.oppScore}</span>
                                                        <span className="text-[9px] opacity-40 mb-0.5 ml-auto">{s.opponent}</span>
                                                    </div>
                                                ) : (
                                                    <div className="text-xs font-bold truncate">
                                                        {formatTime(s.date, false)} <span className="opacity-50 text-[9px]">VS</span> {s.opponent}
                                                    </div>
                                                )
                                            ) : (
                                                <span className="text-xs font-medium opacity-40">Standby</span>
                                            )}
                                        </div>
                                        
                                        <span className="text-[9px] opacity-50 font-medium truncate">
                                            {s && s.active ? (s.isLive || s.isFinal ? s.status : formatTime(s.date)) : "-"}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* FEED */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                        {feed.length === 0 && !data.loading && (
                            <div className="text-center opacity-40 text-sm mt-10">
                                No content found.<br/>
                                <span className="text-xs">Try clicking the sync button.</span>
                            </div>
                        )}
                        
                        {feed.map((item, i) => (
                            <div key={i} className="animate-fadeIn" style={{animationDelay: `${i * 0.05}s`}}>
                                {item.type === 'video' ? (
                                    <a href={`https://youtube.com/watch?v=${item.id}`} target="_blank" className="block bg-black rounded-xl overflow-hidden shadow-lg border border-white/10 group">
                                        <div className="relative">
                                            <img src={item.thumbnail} className="w-full h-40 object-cover opacity-80 group-hover:opacity-100 transition" />
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <div className="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                                    <i className="fas fa-play text-white pl-1 text-sm"></i>
                                                </div>
                                            </div>
                                            <span className="absolute top-2 left-2 bg-red-600 px-1.5 py-0.5 rounded text-[8px] font-bold uppercase text-white shadow">
                                                {item.team} VIDEO
                                            </span>
                                        </div>
                                        <div className="p-3">
                                            <h3 className="font-bold text-sm leading-snug line-clamp-2">{item.title}</h3>
                                            <div className="mt-2 flex justify-between items-center opacity-40 text-[10px]">
                                                <span>YouTube</span>
                                                <span>{formatTime(item.pubDate)}</span>
                                            </div>
                                        </div>
                                    </a>
                                ) : (
                                    <a href={item.link} target="_blank" className={`block bg-white/5 rounded-xl border border-white/5 overflow-hidden active:bg-white/10 transition border-l-4 ${item.teamClass}`}>
                                        <div className="flex">
                                            {item.thumbnail && (
                                                <div className="w-24 h-auto bg-cover bg-center hidden sm:block" style={{backgroundImage: `url(${item.thumbnail})`}}></div>
                                            )}
                                            <div className="p-3 flex-1">
                                                <div className="flex justify-between items-start mb-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded ${item.source === 'ESPN' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'}`}>
                                                            {item.source}
                                                        </span>
                                                        <span className="text-[9px] font-bold uppercase tracking-wider opacity-60 truncate max-w-[100px]">
                                                            {item.author}
                                                        </span>
                                                    </div>
                                                    <span className="text-[9px] opacity-30 whitespace-nowrap ml-2">{formatTime(item.pubDate)}</span>
                                                </div>
                                                <h3 className="font-bold text-sm leading-snug line-clamp-2 mt-1">{item.title}</h3>
                                            </div>
                                        </div>
                                    </a>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Bottom Nav */}
                    <div className="absolute bottom-0 w-full bg-[#0f172a]/95 backdrop-blur-md border-t border-white/10 pb-6 pt-2 px-6 flex justify-between items-center z-30">
                        <button onClick={() => setFilter('all')} className={`nav-item flex flex-col items-center gap-1 p-2 ${filter==='all'?'active':'text-gray-500'}`}>
                            <i className="fas fa-bolt text-lg transition-transform"></i>
                            <span className="text-[9px] font-bold uppercase">Feed</span>
                        </button>
                        <button onClick={() => setFilter('news')} className={`nav-item flex flex-col items-center gap-1 p-2 ${filter==='news'?'active':'text-gray-500'}`}>
                            <i className="fas fa-newspaper text-lg transition-transform"></i>
                            <span className="text-[9px] font-bold uppercase">News</span>
                        </button>
                        <button onClick={() => setFilter('videos')} className={`nav-item flex flex-col items-center gap-1 p-2 ${filter==='videos'?'active':'text-gray-500'}`}>
                            <i className="fab fa-youtube text-lg transition-transform"></i>
                            <span className="text-[9px] font-bold uppercase">Videos</span>
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>